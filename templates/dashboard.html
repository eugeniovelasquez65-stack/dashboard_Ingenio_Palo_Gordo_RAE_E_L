<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Empresarial - Ingenio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --verde-corp:#2d5f4f; --verde-medio:#3a7a65; --verde-claro:#4a9574;
    --gris-oscuro:#2c3e50; --gris-medio:#34495e; --gris-claro:#546e7a;
    --azul-acento:#5dade2; --dorado:#f1c40f; --texto-claro:#ecf0f1; --texto-blanco:#ffffff;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'IBM Plex Sans',sans-serif; background:linear-gradient(135deg,#1a2f2a 0%,#2d5f4f 50%,#1a2f2a 100%); min-height:100vh; color:var(--texto-claro); }
  .header { background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%); border-bottom:3px solid var(--verde-claro); padding:12px 24px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 4px 24px rgba(0,0,0,0.5); }
  .header-logo h1 { font-family:'Inter',sans-serif; font-size:1.35rem; font-weight:700; color:var(--texto-blanco); letter-spacing:0.5px; }
  .header-logo span { font-size:0.72rem; color:var(--azul-acento); letter-spacing:2px; text-transform:uppercase; }
  .header-right { display:flex; align-items:center; gap:16px; }
  .header-user { color:var(--texto-claro); font-size:0.88rem; }
  .btn-logout { background:transparent; border:1.5px solid var(--verde-claro); color:var(--verde-claro); padding:7px 16px; border-radius:6px; cursor:pointer; font-size:0.82rem; font-weight:500; transition:all 0.2s; text-decoration:none; }
  .btn-logout:hover { background:var(--verde-claro); color:var(--gris-oscuro); }
  .tabs { display:flex; background:#1c2833; border-bottom:2px solid #3a7a65; padding:0 24px; }
  .tab { padding:11px 22px; cursor:pointer; font-family:'Inter',sans-serif; font-size:0.85rem; font-weight:500; color:#7f8c8d; border-bottom:3px solid transparent; transition:all 0.2s; }
  .tab.active { color:var(--dorado); border-bottom-color:var(--dorado); }
  .tab:hover:not(.active) { color:var(--texto-claro); }
  .page { display:none; padding:16px 24px; }
  .page.active { display:block; animation:fadeIn 0.3s ease; }
  .dashboard-layout { display:grid; grid-template-columns:500px 1fr; gap:14px; align-items:start; }
  .filters-panel-left { display:flex; flex-direction:column; gap:10px; position:sticky; top:0; }
  .right-panel { display:flex; flex-direction:column; gap:13px; min-width:0; }
  .filters-section { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .btn-excel { background:linear-gradient(135deg,#34495e,#2c3e50); border:1.5px solid var(--verde-claro); color:var(--texto-claro); padding:9px 22px; border-radius:8px; cursor:pointer; font-size:0.83rem; font-weight:500; display:flex; align-items:center; gap:8px; justify-content:center; transition:all 0.2s; width:auto; }
  .btn-excel:hover { background:linear-gradient(135deg,#3a7a65,#2d5f4f); }
  .btn-excel:disabled { opacity:0.6; cursor:not-allowed; }
  .filter-group { background:linear-gradient(135deg,#2c3e50,#34495e); border:1px solid #546e7a; border-radius:8px; overflow:hidden; box-shadow:0 4px 14px rgba(0,0,0,0.35); }
  .filter-title { background:linear-gradient(90deg,#3a7a65,#4a9574); padding:6px 11px; font-family:'Inter',sans-serif; font-size:0.7rem; font-weight:600; letter-spacing:1.2px; color:var(--texto-blanco); text-transform:uppercase; text-align:center; }

  /* ALTURA FIJA siempre */
  .filter-list {
    padding:5px 7px;
    height:156px; min-height:156px; max-height:156px;
    overflow-y:auto;
    scrollbar-width:thin; scrollbar-color:#4a9574 #2c3e50;
  }
  .filter-list::-webkit-scrollbar { width:5px; }
  .filter-list::-webkit-scrollbar-track { background:#2c3e50; }
  .filter-list::-webkit-scrollbar-thumb { background:#4a9574; border-radius:3px; }

  .filter-item { display:flex; align-items:center; gap:7px; padding:3px 5px; cursor:pointer; border-radius:4px; transition:background 0.15s; min-height:26px; }
  .filter-item:hover { background:rgba(74,149,116,0.18); }
  .filter-item input[type="checkbox"] { accent-color:var(--verde-claro); width:13px; height:13px; cursor:pointer; flex-shrink:0; }
  .filter-item label { font-size:0.72rem; color:var(--texto-claro); cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  /* Items ocultos por cascada ‚Äî se esconden completamente */
  .filter-item.cascada-off { display:none !important; }

  .kpis-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:13px; margin-bottom:4px; }
  .kpi-card { border-radius:12px; padding:16px 22px; text-align:center; box-shadow:0 6px 22px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.12); position:relative; overflow:hidden; }
  .kpi-card::before { content:''; position:absolute; top:-60%; left:-60%; width:220%; height:220%; background:radial-gradient(ellipse,rgba(255,255,255,0.08) 0%,transparent 65%); pointer-events:none; }
  .kpi-card.creditos { background:linear-gradient(135deg,#27ae60,#2ecc71); border:2px solid rgba(46,204,113,0.4); }
  .kpi-card.debitos  { background:linear-gradient(135deg,#c0392b,#e74c3c); border:2px solid rgba(231,76,60,0.4); }
  .kpi-card.neto     { background:linear-gradient(135deg,#2980b9,#3498db); border:2px solid rgba(52,152,219,0.4); }
  .kpi-label { font-family:'Inter',sans-serif; font-size:0.74rem; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.92); margin-bottom:7px; }
  .kpi-value { font-family:'Inter',sans-serif; font-size:1.45rem; font-weight:700; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,0.4); word-break:break-all; }
  .cylinders-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
  .cylinder-card { background:linear-gradient(160deg,#2c3e50 0%,#34495e 100%); border:1px solid #546e7a; border-radius:10px; padding:8px 5px 12px; box-shadow:0 4px 18px rgba(0,0,0,0.4); transition:all 0.2s; cursor:pointer; display:flex; flex-direction:column; align-items:center; }
  .cylinder-card:hover { border-color:var(--dorado); box-shadow:0 6px 26px rgba(241,196,15,0.3); transform:translateY(-2px); }
  .cylinder-title { font-family:'Inter',sans-serif; font-size:0.6rem; font-weight:600; letter-spacing:1.5px; color:var(--dorado); text-align:center; text-transform:uppercase; margin-bottom:5px; }
  .cyl-svg-wrap { width:100%; display:flex; justify-content:center; }
  .bar-tooltip { display:none; position:fixed; z-index:9999; background:linear-gradient(160deg,#1c2833,#2c3e50); border:2px solid var(--dorado); border-radius:12px; padding:12px 14px; box-shadow:0 10px 36px rgba(0,0,0,0.75); pointer-events:none; min-width:360px; max-width:480px; }
  .bar-tooltip.visible { display:block; }
  .tooltip-title { font-family:'Inter',sans-serif; font-size:0.68rem; font-weight:700; letter-spacing:1.5px; color:var(--dorado); text-align:center; text-transform:uppercase; margin-bottom:10px; border-bottom:1px solid rgba(241,196,15,0.3); padding-bottom:7px; }
  .bar-row { display:flex; align-items:center; gap:7px; margin-bottom:6px; }
  .bar-label { font-size:0.62rem; color:#95a5a6; min-width:105px; max-width:105px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:right; flex-shrink:0; }
  .bar-track { flex:1; background:rgba(255,255,255,0.07); border-radius:4px; height:18px; position:relative; overflow:visible; }
  .bar-fill { height:100%; border-radius:4px; min-width:3px; display:flex; align-items:center; position:relative; }
  .bar-fill.positivo { background:linear-gradient(90deg,#27ae60,#2ecc71); }
  .bar-fill.negativo { background:linear-gradient(90deg,#c0392b,#e74c3c); }
  .bar-fill.neutro   { background:linear-gradient(90deg,#2980b9,#3498db); }
  .bar-value { position:absolute; right:-5px; top:50%; transform:translate(100%,-50%); font-size:0.6rem; font-weight:700; white-space:nowrap; padding-left:4px; }
  .bar-fill.positivo .bar-value { color:#2ecc71; }
  .bar-fill.negativo .bar-value { color:#e74c3c; }
  .bar-fill.neutro   .bar-value { color:#5dade2; }
  .no-data-msg { color:#95a5a6; text-align:center; padding:16px 6px; font-size:0.72rem; }
  .resumen-container { background:linear-gradient(135deg,#2c3e50,#34495e); border:1px solid #546e7a; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.4); display:flex; flex-direction:column; height:calc(100vh - 130px); overflow:hidden; }
  .resumen-header-bar { padding:14px 18px 10px; border-bottom:2px solid rgba(74,149,116,0.3); flex-shrink:0; }
  .resumen-title { font-family:'Inter',sans-serif; font-size:1.1rem; font-weight:700; letter-spacing:1px; color:var(--dorado); text-transform:uppercase; }
  .resumen-scroll-area { flex:1; overflow-y:auto; overflow-x:auto; }
  .resumen-table { width:100%; border-collapse:collapse; font-size:0.8rem; background:#1c2833; }
  .resumen-table thead tr { background:linear-gradient(90deg,#3a7a65,#4a9574); }
  .resumen-table thead th { padding:11px 10px; font-family:'Inter',sans-serif; font-size:0.76rem; font-weight:600; letter-spacing:1px; color:var(--texto-blanco); text-transform:uppercase; text-align:left; white-space:nowrap; border-right:1px solid rgba(255,255,255,0.15); position:sticky; top:0; z-index:2; background:linear-gradient(90deg,#3a7a65,#4a9574); }
  .resumen-table tbody tr { border-bottom:1px solid rgba(84,110,122,0.3); transition:background 0.15s; }
  .resumen-table tbody tr:hover { background:rgba(74,149,116,0.12); }
  .resumen-table tbody tr:nth-child(even) { background:rgba(0,0,0,0.12); }
  .resumen-table td { padding:9px 10px; color:var(--texto-claro); border-right:1px solid rgba(84,110,122,0.2); white-space:nowrap; }
  .resumen-table td.num { text-align:right; font-family:'Inter',monospace; font-weight:500; }
  .resumen-table td.positivo { color:#81c784; }
  .resumen-table td.negativo { color:#e57373; }
  .resumen-footer { background:linear-gradient(90deg,#34495e,#2c3e50); padding:10px 14px; display:flex; justify-content:flex-end; gap:32px; border-top:2px solid var(--verde-claro); flex-shrink:0; }
  .resumen-footer-total { font-family:'Inter',sans-serif; font-size:0.86rem; font-weight:600; color:var(--dorado); }
  .resumen-footer-total span { color:var(--texto-claro); margin-left:9px; font-weight:400; }
  .detail-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .detail-title { font-family:'Inter',sans-serif; font-size:1.1rem; font-weight:700; letter-spacing:1px; color:var(--dorado); text-transform:uppercase; }
  .table-wrapper { background:#2c3e50; border:1px solid #546e7a; border-radius:10px; overflow:hidden; box-shadow:0 4px 22px rgba(0,0,0,0.4); display:flex; flex-direction:column; }
  .table-scroll-area { flex:1; overflow-x:auto; overflow-y:auto; }
  .detail-table { width:100%; border-collapse:collapse; font-size:0.79rem; }
  .detail-table thead tr { background:linear-gradient(90deg,#3a7a65,#4a9574); }
  .detail-table thead th { padding:11px 10px; font-family:'Inter',sans-serif; font-size:0.76rem; font-weight:600; letter-spacing:1px; color:var(--texto-blanco); text-transform:uppercase; text-align:left; white-space:nowrap; border-right:1px solid rgba(255,255,255,0.15); position:sticky; top:0; z-index:2; background:linear-gradient(90deg,#3a7a65,#4a9574); }
  .detail-table tbody tr { border-bottom:1px solid rgba(84,110,122,0.3); transition:background 0.15s; }
  .detail-table tbody tr:hover { background:rgba(74,149,116,0.12); }
  .detail-table tbody tr:nth-child(even) { background:rgba(0,0,0,0.12); }
  .detail-table td { padding:8px 10px; color:var(--texto-claro); border-right:1px solid rgba(84,110,122,0.2); white-space:nowrap; max-width:260px; overflow:hidden; text-overflow:ellipsis; }
  .detail-table td.num { text-align:right; font-family:'Inter',monospace; font-weight:500; }
  .detail-table td.credito { color:#81c784; }
  .detail-table td.debito  { color:#ffab91; }
  .detail-table td.monto-neg { color:#e57373; }
  .detail-table td.monto-pos { color:#81c784; }
  .table-footer { background:linear-gradient(90deg,#34495e,#2c3e50); padding:10px 14px; display:flex; justify-content:flex-end; gap:32px; border-top:2px solid var(--verde-claro); flex-shrink:0; }
  .footer-total { font-family:'Inter',sans-serif; font-size:0.86rem; font-weight:600; color:var(--dorado); }
  .footer-total span { color:var(--texto-claro); margin-left:9px; font-weight:400; }
  #page-detalle { display:none; padding:12px 24px; height:calc(100vh - 130px); flex-direction:column; }
  #page-detalle.active { display:flex; animation:fadeIn 0.3s ease; }
  #page-detalle .table-wrapper { flex:1; min-height:0; }
  #page-detalle .table-scroll-area { max-height:100%; }
  #page-resumen { display:none; padding:12px 24px; }
  #page-resumen.active { display:block; animation:fadeIn 0.3s ease; }
  ::-webkit-scrollbar { width:7px; height:7px; }
  ::-webkit-scrollbar-track { background:#1c2833; }
  ::-webkit-scrollbar-thumb { background:#4a9574; border-radius:4px; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">
    <h1>üè≠ DEPARTAMENTO DE PRESUPUESTOS IPG</h1>
    <span>Ingenio Palo Gordo, S.A. - Sistema de Presupuesto</span>
  </div>
  <div class="header-right">
    <span class="header-user">üë§ {{ nombre }}</span>
    <a href="/logout" class="btn-logout">Cerrar Sesi√≥n</a>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('dashboard',this)">üìä Dashboard</div>
  <div class="tab" onclick="switchTab('resumen',this)">üìà Resumen de Saldos</div>
  <div class="tab" onclick="switchTab('detalle',this)">üìã Detalle de Transacciones</div>
</div>

<div id="global-tooltip" class="bar-tooltip">
  <div class="tooltip-title" id="tooltip-mes-label">DEBITOS POR CHEQUERA</div>
  <div class="bar-chart-container" id="tooltip-bar-container"></div>
</div>

<!-- ========== DASHBOARD ========== -->
<div id="page-dashboard" class="page active">
  <div class="dashboard-layout">
    <div class="filters-panel-left">
      <button class="btn-excel" id="btn-excel-top" onclick="exportarExcel(this)">‚ñ∂ Descargar Excel</button>
      <div class="filters-section">

        <div class="filter-group">
          <div class="filter-title">Administraci√≥n</div>
          <div class="filter-list" id="filter-administracion">
            {% for item in administraciones %}
            <div class="filter-item" data-col="administracion" data-val="{{ item }}">
              <input type="checkbox" id="adm-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="adm-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Gerencia</div>
          <div class="filter-list" id="filter-gerencia">
            {% for item in gerencias %}
            <div class="filter-item" data-col="gerencia" data-val="{{ item }}">
              <input type="checkbox" id="ger-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="ger-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Centro de Costo</div>
          <div class="filter-list" id="filter-centro">
            {% for item in centros_costo %}
            <div class="filter-item" data-col="centro_costo" data-val="{{ item }}">
              <input type="checkbox" id="cc-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="cc-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Nombre Centro Costo</div>
          <div class="filter-list" id="filter-responsable">
            {% for item in responsables %}
            <div class="filter-item" data-col="responsable" data-val="{{ item }}">
              <input type="checkbox" id="res-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="res-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Chequera</div>
          <div class="filter-list" id="filter-chequera">
            {% for item in chequeras %}
            <div class="filter-item" data-col="chequera" data-val="{{ item }}">
              <input type="checkbox" id="cheq-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="cheq-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Cod. Administraci√≥n</div>
          <div class="filter-list" id="filter-cod-admin">
            {% for item in cod_administraciones %}
            <div class="filter-item" data-col="cod_admin" data-val="{{ item }}">
              <input type="checkbox" id="ca-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="ca-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Cod. Responsable</div>
          <div class="filter-list" id="filter-cod-responsable">
            {% for item in cod_responsables %}
            <div class="filter-item" data-col="cod_responsable" data-val="{{ item }}">
              <input type="checkbox" id="cr-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="cr-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Cod. Centro de Costo</div>
          <div class="filter-list" id="filter-cod-centro">
            {% for item in cod_centros %}
            <div class="filter-item" data-col="cod_centro" data-val="{{ item }}">
              <input type="checkbox" id="ccc-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="ccc-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>

    <div class="right-panel">
      <div class="kpis-row">
        <div class="kpi-card creditos">
          <div class="kpi-label">üí∞ Total Cr√©ditos</div>
          <div class="kpi-value" id="kpi-creditos">{{ kpis.total_creditos }}</div>
        </div>
        <div class="kpi-card debitos">
          <div class="kpi-label">üìâ Total D√©bitos</div>
          <div class="kpi-value" id="kpi-debitos">{{ kpis.total_debitos }}</div>
        </div>
        <div class="kpi-card neto">
          <div class="kpi-label">üíµ Saldo Actual</div>
          <div class="kpi-value" id="kpi-neto">{{ kpis.saldo_neto }}</div>
        </div>
      </div>
      <div class="cylinders-grid" id="cylinders-container"></div>
    </div>
  </div>
</div>

<!-- ========== RESUMEN ========== -->
<div id="page-resumen" class="page">
  <div class="resumen-container">
    <div class="resumen-header-bar">
      <div class="resumen-title">üìà Resumen de Saldos por Centro de Costo y Chequera</div>
    </div>
    <div class="resumen-scroll-area">
      <table class="resumen-table">
        <thead><tr>
          <th>Centro de Costo</th><th>Descripci√≥n</th><th>Chequera</th>
          <th>Cr√©ditos</th><th>D√©bitos</th><th>Saldo</th>
        </tr></thead>
        <tbody id="tbody-resumen"></tbody>
      </table>
    </div>
    <div class="resumen-footer">
      <div class="resumen-footer-total">Total Cr√©ditos <span id="total-creditos">Q0.00</span></div>
      <div class="resumen-footer-total">Total D√©bitos <span id="total-debitos">Q0.00</span></div>
      <div class="resumen-footer-total">Saldo Actual <span id="total-saldo">Q0.00</span></div>
    </div>
  </div>
</div>

<!-- ========== DETALLE ========== -->
<div id="page-detalle" class="page">
  <div class="detail-header">
    <div class="detail-title">üìã Detalle de Transacciones</div>
    <button class="btn-excel" id="btn-excel-detalle" onclick="exportarExcel(this)">‚ñ∂ Descargar Excel</button>
  </div>
  <div class="table-wrapper">
    <div class="table-scroll-area">{{ tabla_html | safe }}</div>
    <div class="table-footer">
      <div class="footer-total">Total Cr√©ditos <span id="footer-creditos">{{ kpis.total_creditos }}</span></div>
      <div class="footer-total">Total D√©bitos <span id="footer-debitos">{{ kpis.total_debitos }}</span></div>
      <div class="footer-total">Saldo Actual <span id="footer-neto">{{ kpis.saldo_neto }}</span></div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Estado global ‚îÄ‚îÄ
const DATOS_MESES     = {{ datos_meses | tojson }};
const DATOS_CHEQUERAS = {{ datos_chequeras_mes | tojson }};
const MESES_ORDEN     = ['NOVIEMBRE','DICIEMBRE','ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE'];
let datosResumenActuales = {{ datos_resumen | tojson }};
let filtrosActuales = {};

// Mapeo clave filtro ‚Üí id contenedor
const SEG_MAP = {
  'administracion':  'filter-administracion',
  'gerencia':        'filter-gerencia',
  'centro_costo':    'filter-centro',
  'responsable':     'filter-responsable',
  'chequera':        'filter-chequera',
  'cod_admin':       'filter-cod-admin',
  'cod_responsable': 'filter-cod-responsable',
  'cod_centro':      'filter-cod-centro',
};

// ‚îÄ‚îÄ Utilidades ‚îÄ‚îÄ
function formatK(v){
  if(!v||v===0) return 'Q0';
  const a=Math.abs(v);
  if(a>=1e9) return 'Q'+(v/1e9).toFixed(1)+'B';
  if(a>=1e6) return 'Q'+(v/1e6).toFixed(1)+'M';
  if(a>=1e3) return 'Q'+(v/1e3).toFixed(1)+'K';
  return 'Q'+v.toFixed(0);
}
function formatCurrency(v){
  return 'Q'+(v||0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g,'$&,');
}

// ‚îÄ‚îÄ FILTROS EN CASCADA: ocultar los que no corresponden ‚îÄ‚îÄ
function actualizarCascada(segmentadores){
  if(!segmentadores) return;

  // Verificar si hay alg√∫n filtro activo
  const hayFiltrosActivos = Object.values(filtrosActuales).some(v => v && v.length > 0);

  Object.entries(SEG_MAP).forEach(([col, containerId])=>{
    const disponibles = segmentadores[col] || [];
    const container   = document.getElementById(containerId);
    if(!container) return;

    container.querySelectorAll('.filter-item').forEach(item=>{
      const val = item.getAttribute('data-val');
      const cb  = item.querySelector('input[type=checkbox]');

      if(!hayFiltrosActivos){
        // Sin filtros activos: mostrar todo
        item.classList.remove('cascada-off');
        if(cb) cb.disabled = false;
      } else if(disponibles.includes(val)){
        // Est√° disponible: mostrar
        item.classList.remove('cascada-off');
        if(cb) cb.disabled = false;
      } else {
        // No disponible: ocultar y desmarcar
        item.classList.add('cascada-off');
        if(cb){ cb.checked = false; cb.disabled = true; }
      }
    });
  });
}

// ‚îÄ‚îÄ EXPORTAR EXCEL ‚îÄ‚îÄ
async function exportarExcel(btn){
  btn.disabled=true; btn.textContent='‚è≥ Generando...';
  try {
    const wb=XLSX.utils.book_new();

    // Hoja 1 ‚Äî Detalle
    const tablaDOM=document.querySelector('.table-wrapper .table-scroll-area table');
    if(tablaDOM){
      const headers=Array.from(tablaDOM.querySelectorAll('thead th')).map(th=>th.textContent.trim());
      const filas=[];
      tablaDOM.querySelectorAll('tbody tr').forEach(tr=>{
        const celdas=Array.from(tr.querySelectorAll('td')).map(td=>{
          const t=td.textContent.trim(); const n=parseFloat(t.replace(/,/g,'')); return isNaN(n)?t:n;
        });
        if(celdas.length) filas.push(celdas);
      });
      const ws1=XLSX.utils.aoa_to_sheet([headers,...filas]);
      ws1['!cols']=headers.map(()=>({wch:20}));
      XLSX.utils.book_append_sheet(wb,ws1,'Detalle');
    }

    // Hoja 2 ‚Äî Resumen de Saldos
    const hRes=['Centro de Costo','Descripci√≥n','Chequera','Cr√©ditos','D√©bitos','Saldo'];
    const fRes=datosResumenActuales.map(r=>[r.centro_costo,r.desc_centro||'',r.chequera,r.creditos,r.debitos,r.creditos-r.debitos]);
    const ws2=XLSX.utils.aoa_to_sheet([hRes,...fRes]);
    ws2['!cols']=[20,28,22,14,14,14].map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws2,'Resumen de Saldos');

    // Hoja 3 ‚Äî KPIs por Mes
    const hKpi=['Mes','Cr√©ditos','D√©bitos','Saldo'];
    const fKpi=MESES_ORDEN.map(mes=>{ const d=DATOS_MESES[mes]||{creditos:0,debitos:0}; return [mes,d.creditos,d.debitos,d.creditos-d.debitos]; });
    const ws3=XLSX.utils.aoa_to_sheet([hKpi,...fKpi]);
    ws3['!cols']=[16,14,14,14].map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws3,'KPIs por Mes');

    // Hoja 4 ‚Äî Datos ERP Completo
    const respErp=await fetch('/api/exportar-datos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(filtrosActuales)});
    const dataErp=await respErp.json();
    if(dataErp.columnas&&dataErp.columnas.length>0){
      const ws4=XLSX.utils.aoa_to_sheet([dataErp.columnas,...dataErp.filas]);
      ws4['!cols']=dataErp.columnas.map(()=>({wch:18}));
      XLSX.utils.book_append_sheet(wb,ws4,'Datos ERP Completo');
    }

    const fecha=new Date().toISOString().slice(0,10).replace(/-/g,'');
    XLSX.writeFile(wb,`reporte_IPG_${fecha}.xlsx`);
  } catch(err){
    console.error('Error Excel:',err); alert('Error al generar el Excel. Intente de nuevo.');
  } finally {
    btn.disabled=false; btn.textContent='‚ñ∂ Descargar Excel';
  }
}

// ‚îÄ‚îÄ CILINDRO SVG ‚îÄ‚îÄ
function buildCylinderSVG(creditos,debitos,w=100,h=160){
  const cx=50,rx=30,ry=8,top=22,bodyH=110,bot=top+bodyH;
  const overdraft=debitos>creditos&&debitos>0;
  const ratio=debitos>0?Math.min(debitos/Math.max(creditos,1),1.0):0;
  const fillTopY=bot-ratio*bodyH;
  const c1=overdraft?'#c62828':'#d35400',c2=overdraft?'#ef5350':'#e67e22',c3=overdraft?'#ffcdd2':'#f39c12';
  const uid='c'+Math.random().toString(36).slice(2,8);
  return `<svg width="${w}" height="${h+28}" viewBox="0 0 ${w} ${h+28}" xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
<defs>
  <linearGradient id="gg-${uid}" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#3a7a65" stop-opacity="0.25"/><stop offset="50%" stop-color="#4a9574" stop-opacity="0.15"/><stop offset="100%" stop-color="#2d5f4f" stop-opacity="0.28"/></linearGradient>
  <linearGradient id="gf-${uid}" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="${c1}" stop-opacity="0.88"/><stop offset="48%" stop-color="${c2}" stop-opacity="1.0"/><stop offset="100%" stop-color="${c1}" stop-opacity="0.82"/></linearGradient>
  <radialGradient id="sv-${uid}" cx="0.4" cy="0.3"><stop offset="0%" stop-color="#f0f0f0"/><stop offset="50%" stop-color="#bdc3c7"/><stop offset="100%" stop-color="#7f8c8d"/></radialGradient>
</defs>
<ellipse cx="${cx}" cy="${bot+ry+6}" rx="${rx+6}" ry="6" fill="rgba(0,0,0,0.35)"/>
<ellipse cx="${cx}" cy="${bot+ry+4}" rx="${rx+4}" ry="5" fill="url(#sv-${uid})" stroke="#95a5a6" stroke-width="1"/>
<ellipse cx="${cx}" cy="${bot+ry+3}" rx="${rx+2}" ry="3.5" fill="rgba(236,240,241,0.6)"/>
<ellipse cx="${cx}" cy="${bot}" rx="${rx}" ry="${ry}" fill="#1a2f2a" stroke="#4a9574" stroke-width="1"/>
<rect x="${cx-rx}" y="${top}" width="${rx*2}" height="${bodyH}" fill="url(#gg-${uid})"/>
<line x1="${cx-rx}" y1="${top}" x2="${cx-rx}" y2="${bot}" stroke="rgba(180,235,180,0.4)" stroke-width="1.3"/>
${ratio>0?`<rect x="${cx-rx+1}" y="${fillTopY}" width="${rx*2-2}" height="${bot-fillTopY}" fill="url(#gf-${uid})"/><line x1="${cx-rx+1}" y1="${fillTopY}" x2="${cx+rx-1}" y2="${fillTopY}" stroke="${c3}" stroke-width="1" opacity="0.7"/><ellipse cx="${cx}" cy="${fillTopY}" rx="${rx-1}" ry="${ry-1}" fill="${c2}" opacity="0.6"/>`:''}
<ellipse cx="${cx}" cy="${top}" rx="${rx}" ry="${ry}" fill="#2d5f4f" stroke="rgba(180,235,180,0.6)" stroke-width="1.2"/>
<ellipse cx="${cx}" cy="${bot}" rx="${rx}" ry="${ry}" fill="#2a5a4a" stroke="rgba(180,235,180,0.5)" stroke-width="1.2"/>
<line x1="${cx-rx-12}" y1="${top}" x2="${cx+rx+5}" y2="${top}" stroke="#f1c40f" stroke-width="1.3" stroke-dasharray="4,3" opacity="0.9"/>
<line x1="${cx-rx-12}" y1="${top-5}" x2="${cx-rx-12}" y2="${top+5}" stroke="#f1c40f" stroke-width="1.8"/>
<text x="${cx-rx-14}" y="${top-7}" font-family="'Inter',sans-serif" font-size="8" font-weight="700" fill="#f1c40f" text-anchor="end">${formatK(creditos)}</text>
<text x="${cx-rx-14}" y="${top+14}" font-family="'Inter',sans-serif" font-size="6" fill="rgba(241,196,15,0.8)" text-anchor="end">M√ÅX</text>
${ratio>0?`<line x1="${cx+rx+2}" y1="${fillTopY}" x2="${cx+rx+10}" y2="${fillTopY}" stroke="${overdraft?'#ff8a80':'#f39c12'}" stroke-width="1" opacity="0.85"/><text x="${cx+rx+12}" y="${fillTopY+4}" font-family="'Inter',sans-serif" font-size="8" font-weight="700" fill="${overdraft?'#ff8a80':'#f39c12'}" text-anchor="start">${formatK(debitos)}</text>`:`<text x="${cx}" y="${bot-8}" font-family="'Inter',sans-serif" font-size="7" fill="#7f8c8d" text-anchor="middle">Sin d√©bitos</text>`}
${overdraft?`<text x="${cx}" y="${top-13}" font-family="'Inter',sans-serif" font-size="8" font-weight="700" fill="#ff5252" text-anchor="middle">‚ö† SOBRE</text>`:''}
</svg>`;
}

// ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ
const tooltipEl=document.getElementById('global-tooltip');
const tooltipMes=document.getElementById('tooltip-mes-label');
const tooltipCont=document.getElementById('tooltip-bar-container');
let hideTimeout;
function posTooltip(e){ const tw=340,th=220,m=14; let x=e.clientX+m,y=e.clientY+m; if(x+tw>window.innerWidth)x=e.clientX-tw-m; if(y+th>window.innerHeight)y=e.clientY-th-m; tooltipEl.style.left=x+'px'; tooltipEl.style.top=y+'px'; }
function mostrarTooltipBarras(mes,e){
  clearTimeout(hideTimeout); posTooltip(e);
  tooltipMes.textContent=mes+' ¬∑ D√©bitos por chequera';
  tooltipEl.classList.add('visible');
  const ch=DATOS_CHEQUERAS[mes]||{},noms=Object.keys(ch),debs=Object.values(ch);
  if(!noms.length){ tooltipCont.innerHTML='<div class="no-data-msg">Sin d√©bitos registrados</div>'; return; }
  const maxV=Math.max(...debs.map(Math.abs),1);
  tooltipCont.innerHTML=noms.map((n,i)=>{ const v=debs[i],pct=Math.min(Math.abs(v)/maxV*100,100),cls=v===0?'neutro':(-v>=0?'positivo':'negativo'); return `<div class="bar-row"><div class="bar-label" title="${n}">${n}</div><div class="bar-track"><div class="bar-fill ${cls}" style="width:${pct}%"><span class="bar-value">${formatK(v)}</span></div></div></div>`; }).join('');
}
function moverTooltip(e){ posTooltip(e); }
function ocultarTooltip(){ hideTimeout=setTimeout(()=>tooltipEl.classList.remove('visible'),130); }

// ‚îÄ‚îÄ RENDER CILINDROS ‚îÄ‚îÄ
function renderCilindros(dm){
  const c=document.getElementById('cylinders-container'); c.innerHTML='';
  MESES_ORDEN.forEach(mes=>{
    const d=dm[mes]||{creditos:0,debitos:0};
    const card=document.createElement('div'); card.className='cylinder-card';
    card.innerHTML=`<div class="cylinder-title">${mes}</div><div class="cyl-svg-wrap">${buildCylinderSVG(d.creditos,d.debitos)}</div>`;
    c.appendChild(card);
    card.addEventListener('mouseenter',e=>mostrarTooltipBarras(mes,e));
    card.addEventListener('mousemove',e=>moverTooltip(e));
    card.addEventListener('mouseleave',()=>ocultarTooltip());
  });
}

// ‚îÄ‚îÄ RENDER RESUMEN ‚îÄ‚îÄ
function renderResumen(datos){
  const tbody=document.getElementById('tbody-resumen'); tbody.innerHTML=''; let tC=0,tD=0;
  if(!datos||!datos.length){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px;color:#95a5a6;">Sin datos para mostrar</td></tr>';
    ['total-creditos','total-debitos','total-saldo'].forEach(id=>document.getElementById(id).textContent='Q0.00');
    return;
  }
  [...datos].sort((a,b)=>(a.creditos-a.debitos)-(b.creditos-b.debitos)).forEach(row=>{
    const saldo=row.creditos-row.debitos; tC+=row.creditos; tD+=row.debitos;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${row.centro_costo}</td><td>${row.desc_centro||''}</td><td>${row.chequera}</td>
      <td class="num positivo">${formatCurrency(row.creditos)}</td>
      <td class="num negativo">${formatCurrency(row.debitos)}</td>
      <td class="num ${saldo>=0?'positivo':'negativo'}">${formatCurrency(saldo)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('total-creditos').textContent=formatCurrency(tC);
  document.getElementById('total-debitos').textContent=formatCurrency(tD);
  const sEl=document.getElementById('total-saldo');
  sEl.textContent=formatCurrency(tC-tD); sEl.style.color=(tC-tD)>=0?'#81c784':'#e57373';
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(p,el){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active'); el.classList.add('active');
  if(p==='dashboard') setTimeout(()=>renderCilindros(DATOS_MESES),100);
  if(p==='resumen')   renderResumen(datosResumenActuales);
}

// ‚îÄ‚îÄ OBTENER CHECKED (solo items visibles y habilitados) ‚îÄ‚îÄ
function getChecked(id){
  return Array.from(document.querySelectorAll(`#${id} .filter-item:not(.cascada-off) input[type=checkbox]:checked`))
    .map(b=>b.value);
}

// ‚îÄ‚îÄ APLICAR FILTROS ‚îÄ‚îÄ
function aplicarFiltros(){
  // Recolectar valores marcados
  filtrosActuales = {
    administracion:  getChecked('filter-administracion'),
    gerencia:        getChecked('filter-gerencia'),
    responsable:     getChecked('filter-responsable'),
    centro_costo:    getChecked('filter-centro'),
    chequera:        getChecked('filter-chequera'),
    cod_responsable: getChecked('filter-cod-responsable'),
    cod_admin:       getChecked('filter-cod-admin'),
    cod_centro:      getChecked('filter-cod-centro'),
  };

  fetch('/api/filtrar',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(filtrosActuales)
  })
  .then(r=>r.json())
  .then(data=>{
    // KPIs
    document.getElementById('kpi-creditos').textContent    = data.kpis.total_creditos;
    document.getElementById('kpi-debitos').textContent     = data.kpis.total_debitos;
    document.getElementById('kpi-neto').textContent        = data.kpis.saldo_neto;
    document.getElementById('footer-creditos').textContent = data.kpis.total_creditos;
    document.getElementById('footer-debitos').textContent  = data.kpis.total_debitos;
    document.getElementById('footer-neto').textContent     = data.kpis.saldo_neto;

    // Sync datos globales
    if(data.datos_chequeras_mes){ Object.keys(DATOS_CHEQUERAS).forEach(k=>delete DATOS_CHEQUERAS[k]); Object.assign(DATOS_CHEQUERAS,data.datos_chequeras_mes); }
    if(data.datos_meses){ Object.keys(DATOS_MESES).forEach(k=>delete DATOS_MESES[k]); Object.assign(DATOS_MESES,data.datos_meses); }
    if(data.datos_resumen) datosResumenActuales=data.datos_resumen;

    // Cascada: ocultar/mostrar items seg√∫n disponibles
    if(data.segmentadores) actualizarCascada(data.segmentadores);

    // Renderizar
    renderCilindros(data.datos_meses);
    if(document.getElementById('page-resumen').classList.contains('active')) renderResumen(datosResumenActuales);
    document.querySelector('.table-wrapper .table-scroll-area').innerHTML=data.tabla_html;
    fixDetalleTable();
  })
  .catch(e=>console.error('Error filtros:',e));
}

// ‚îÄ‚îÄ FIX TABLA DETALLE ‚îÄ‚îÄ
function fixDetalleTable(){
  const sa=document.querySelector('.table-wrapper .table-scroll-area'); if(!sa) return;
  const tbl=sa.querySelector('table'); if(!tbl) return;
  const ths=Array.from(tbl.querySelectorAll('thead th')); let si=-1;
  ths.forEach((th,i)=>{ if(th.textContent.trim().toUpperCase()==='FECHA_OPER') si=i; });
  if(si<0) return;
  const tbody=tbl.querySelector('tbody'); if(!tbody) return;
  const rows=Array.from(tbody.querySelectorAll('tr'));
  const pd=s=>{ if(!s) return 0; if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s).getTime(); const p=s.split(/[\/\-]/); if(p.length===3){ if(p[0].length===4) return new Date(s).getTime(); return new Date(`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`).getTime(); } return new Date(s).getTime(); };
  rows.sort((a,b)=>{ const tA=a.querySelectorAll('td'),tB=b.querySelectorAll('td'); return pd(tB[si]?.textContent.trim()||'')-pd(tA[si]?.textContent.trim()||''); });
  rows.forEach(r=>tbody.appendChild(r));
}

// ‚îÄ‚îÄ INICIO ‚îÄ‚îÄ
renderCilindros(DATOS_MESES);
renderResumen(datosResumenActuales);
document.addEventListener('DOMContentLoaded',()=>fixDetalleTable());
fixDetalleTable();
</script>
</body>
</html>