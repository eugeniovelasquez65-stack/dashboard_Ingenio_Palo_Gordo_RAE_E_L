<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Empresarial - Ingenio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<style>
  :root {
    --verde-corp: #2d5f4f;
    --verde-medio: #3a7a65;
    --verde-claro: #4a9574;
    --gris-oscuro: #2c3e50;
    --gris-medio: #34495e;
    --gris-claro: #546e7a;
    --azul-acento: #5dade2;
    --dorado: #f1c40f;
    --naranja: #e67e22;
    --rojo: #e74c3c;
    --plata: #bdc3c7;
    --texto-claro: #ecf0f1;
    --texto-blanco: #ffffff;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'IBM Plex Sans',sans-serif;
    background: linear-gradient(135deg, #1a2f2a 0%, #2d5f4f 50%, #1a2f2a 100%);
    min-height:100vh;
    color:var(--texto-claro);
  }

  /* HEADER */
  .header {
    background:linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border-bottom:3px solid var(--verde-claro);
    padding:12px 24px;
    display:flex; align-items:center; justify-content:space-between;
    box-shadow:0 4px 24px rgba(0,0,0,0.5);
  }
  .header-logo h1 {
    font-family:'Inter',sans-serif; font-size:1.35rem; font-weight:700;
    color:var(--texto-blanco); letter-spacing:0.5px;
    text-shadow:0 2px 8px rgba(0,0,0,0.3);
  }
  .header-logo span {
    font-size:0.72rem; color:var(--azul-acento); letter-spacing:2px;
    text-transform:uppercase; font-weight:400;
  }
  .header-right { display:flex; align-items:center; gap:16px; }
  .header-user { color:var(--texto-claro); font-size:0.88rem; }
  .btn-logout {
    background:transparent; border:1.5px solid var(--verde-claro);
    color:var(--verde-claro); padding:7px 16px; border-radius:6px;
    cursor:pointer; font-size:0.82rem; font-weight:500;
    transition:all 0.2s; text-decoration:none;
  }
  .btn-logout:hover {
    background:var(--verde-claro); color:var(--gris-oscuro);
    box-shadow:0 0 12px rgba(74,149,116,0.4);
  }

  /* TABS */
  .tabs {
    display:flex; background:#1c2833; border-bottom:2px solid #3a7a65; padding:0 24px;
  }
  .tab {
    padding:11px 22px; cursor:pointer; font-family:'Inter',sans-serif;
    font-size:0.85rem; font-weight:500; letter-spacing:0.5px; color:#7f8c8d;
    border-bottom:3px solid transparent; transition:all 0.2s;
  }
  .tab.active { color:var(--dorado); border-bottom-color:var(--dorado); }
  .tab:hover:not(.active) { color:var(--texto-claro); }

  /* PAGES */
  .page { display:none; padding:16px 24px; }
  .page.active { display:block; animation:fadeIn 0.3s ease; }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT DASHBOARD: panel izquierdo (filtros 2col√ó4fil) + panel derecho ‚îÄ‚îÄ‚îÄ */
  .dashboard-layout {
    display: grid;
    grid-template-columns: 500px 1fr;
    gap: 14px;
    align-items: start;
  }

  /* Panel izquierdo: filtros + bot√≥n excel */
  .filters-panel-left {
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: sticky;
    top: 0;
  }

  /* Panel derecho: KPIs + cilindros */
  .right-panel {
    display: flex;
    flex-direction: column;
    gap: 13px;
    min-width: 0;
  }

  /* Secci√≥n de filtros: 2 columnas √ó 4 filas */
  .filters-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .btn-excel {
    background:linear-gradient(135deg, #34495e, #2c3e50);
    border:1.5px solid var(--verde-claro); color:var(--texto-claro);
    padding:9px 22px; border-radius:8px; cursor:pointer; font-size:0.83rem; font-weight:500;
    display:flex; align-items:center; gap:8px; justify-content:center;
    transition:all 0.2s; text-decoration:none; width:auto;
  }
  .btn-excel:hover {
    background:linear-gradient(135deg, #3a7a65, #2d5f4f);
    box-shadow:0 0 16px rgba(74,149,116,0.35);
  }

  .filter-group {
    background:linear-gradient(135deg, #2c3e50, #34495e);
    border:1px solid #546e7a; border-radius:8px; overflow:hidden;
    box-shadow:0 4px 14px rgba(0,0,0,0.35);
  }
  .filter-title {
    background:linear-gradient(90deg, #3a7a65, #4a9574); padding:6px 11px;
    font-family:'Inter',sans-serif; font-size:0.7rem; font-weight:600;
    letter-spacing:1.2px; color:var(--texto-blanco); text-transform:uppercase;
    text-align:center;
  }
  /* Exactamente 4 l√≠neas visibles por segmentador */
  .filter-list {
    padding:5px 7px;
    /* 4 items * altura item (~26px) = 104px */
    max-height: 156px;
    overflow-y:auto;
    scrollbar-width:thin; scrollbar-color:#4a9574 #2c3e50;
  }
  .filter-list::-webkit-scrollbar { width:5px; }
  .filter-list::-webkit-scrollbar-track { background:#2c3e50; }
  .filter-list::-webkit-scrollbar-thumb { background:#4a9574; border-radius:3px; }
  .filter-item {
    display:flex; align-items:center; gap:7px; padding:3px 5px;
    cursor:pointer; border-radius:4px; transition:background 0.15s;
    min-height: 26px;
  }
  .filter-item:hover { background:rgba(74,149,116,0.18); }
  .filter-item input[type="checkbox"] {
    accent-color:var(--verde-claro); width:13px; height:13px; cursor:pointer; flex-shrink:0;
  }
  .filter-item label {
    font-size:0.72rem; color:var(--texto-claro); cursor:pointer;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* KPIs */
  .kpis-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:13px; margin-bottom:4px; }
  .kpi-card {
    border-radius:12px; padding:16px 22px; text-align:center;
    box-shadow:0 6px 22px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.12);
    position:relative; overflow:hidden; animation:fadeIn 0.4s ease both;
  }
  .kpi-card::before {
    content:''; position:absolute; top:-60%; left:-60%; width:220%; height:220%;
    background:radial-gradient(ellipse, rgba(255,255,255,0.08) 0%, transparent 65%);
    pointer-events:none;
  }
  .kpi-card.creditos { background:linear-gradient(135deg, #27ae60, #2ecc71); border:2px solid rgba(46,204,113,0.4); }
  .kpi-card.debitos  { background:linear-gradient(135deg, #c0392b, #e74c3c); border:2px solid rgba(231,76,60,0.4); }
  .kpi-card.neto     { background:linear-gradient(135deg, #2980b9, #3498db); border:2px solid rgba(52,152,219,0.4); }
  .kpi-label {
    font-family:'Inter',sans-serif; font-size:0.74rem; font-weight:600;
    letter-spacing:1.5px; text-transform:uppercase; color:rgba(255,255,255,0.92); margin-bottom:7px;
  }
  .kpi-value {
    font-family:'Inter',sans-serif; font-size:1.45rem; font-weight:700;
    color:#fff; text-shadow:0 2px 10px rgba(0,0,0,0.4); word-break:break-all;
  }

  /* CILINDROS */
  .cylinders-section { display:flex; flex-direction:column; gap:12px; }
  .cylinders-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
  .cylinder-card {
    background:linear-gradient(160deg, #2c3e50 0%, #34495e 100%);
    border:1px solid #546e7a; border-radius:10px; padding:8px 5px 12px;
    box-shadow:0 4px 18px rgba(0,0,0,0.4);
    position:relative; transition:all 0.2s; cursor:pointer;
    display:flex; flex-direction:column; align-items:center;
  }
  .cylinder-card:hover {
    border-color:var(--dorado);
    box-shadow:0 6px 26px rgba(241,196,15,0.3);
    transform:translateY(-2px);
  }
  .cylinder-title {
    font-family:'Inter',sans-serif; font-size:0.6rem; font-weight:600;
    letter-spacing:1.5px; color:var(--dorado); text-align:center;
    text-transform:uppercase; margin-bottom:5px;
  }
  .cyl-svg-wrap { width:100%; display:flex; justify-content:center; }

  /* ‚îÄ‚îÄ‚îÄ TOOLTIP CON GR√ÅFICO DE BARRAS ‚îÄ‚îÄ‚îÄ */
  .bar-tooltip {
    display:none; position:fixed; z-index:9999;
    background:linear-gradient(160deg, #1c2833, #2c3e50);
    border:2px solid var(--dorado); border-radius:12px; padding:12px 14px;
    box-shadow:0 10px 36px rgba(0,0,0,0.75), 0 0 20px rgba(241,196,15,0.18);
    pointer-events:none; min-width:360px; max-width:480px;
  }
  .bar-tooltip.visible { display:block; animation:tooltipIn 0.15s ease; }
  @keyframes tooltipIn {
    from{opacity:0; transform:scale(0.92) translateY(4px)}
    to{opacity:1; transform:scale(1) translateY(0)}
  }
  .tooltip-title {
    font-family:'Inter',sans-serif; font-size:0.68rem; font-weight:700;
    letter-spacing:1.5px; color:var(--dorado); text-align:center;
    text-transform:uppercase; margin-bottom:10px;
    border-bottom:1px solid rgba(241,196,15,0.3); padding-bottom:7px;
  }
  .bar-chart-container { width:100%; }
  .bar-row {
    display:flex; align-items:center; gap:7px; margin-bottom:6px;
  }
  .bar-label {
    font-size:0.62rem; color:#95a5a6; min-width:105px; max-width:105px;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:right;
    flex-shrink:0;
  }
  .bar-track {
    flex:1; background:rgba(255,255,255,0.07); border-radius:4px;
    height:18px; position:relative; overflow:visible;
  }
  .bar-fill {
    height:100%; border-radius:4px; min-width:3px;
    display:flex; align-items:center; position:relative;
    transition:width 0.3s ease;
  }
  .bar-fill.positivo { background:linear-gradient(90deg, #27ae60, #2ecc71); }
  .bar-fill.negativo { background:linear-gradient(90deg, #c0392b, #e74c3c); }
  .bar-fill.neutro   { background:linear-gradient(90deg, #2980b9, #3498db); }
  .bar-value {
    position:absolute; right:-5px; top:50%; transform:translate(100%,-50%);
    font-size:0.6rem; font-weight:700; white-space:nowrap; padding-left:4px;
  }
  .bar-fill.positivo .bar-value { color:#2ecc71; }
  .bar-fill.negativo .bar-value { color:#e74c3c; }
  .bar-fill.neutro   .bar-value { color:#5dade2; }
  .no-data-msg {
    color:#95a5a6; text-align:center; padding:16px 6px;
    font-size:0.72rem; letter-spacing:1px;
  }

  /* RESUMEN DE SALDOS */
  .resumen-container {
    background:linear-gradient(135deg, #2c3e50, #34495e);
    border:1px solid #546e7a; border-radius:10px;
    box-shadow:0 4px 20px rgba(0,0,0,0.4);
    display:flex; flex-direction:column;
    height: calc(100vh - 130px); /* ajuste total viewport */
    overflow: hidden;
  }
  .resumen-header-bar {
    padding: 14px 18px 10px;
    border-bottom:2px solid rgba(74,149,116,0.3);
    flex-shrink: 0;
  }
  .resumen-title {
    font-family:'Inter',sans-serif; font-size:1.1rem; font-weight:700;
    letter-spacing:1px; color:var(--dorado); text-transform:uppercase;
  }
  .resumen-scroll-area {
    flex:1; overflow-y:auto; overflow-x:auto;
  }
  .resumen-table {
    width:100%; border-collapse:collapse; font-size:0.8rem;
    background:#1c2833;
  }
  .resumen-table thead tr { background:linear-gradient(90deg, #3a7a65, #4a9574); }
  .resumen-table thead th {
    padding:11px 10px; font-family:'Inter',sans-serif; font-size:0.76rem;
    font-weight:600; letter-spacing:1px; color:var(--texto-blanco);
    text-transform:uppercase; text-align:left; white-space:nowrap;
    border-right:1px solid rgba(255,255,255,0.15);
    position: sticky; top:0; z-index:2;
    background:linear-gradient(90deg, #3a7a65, #4a9574);
  }
  .resumen-table tbody tr { border-bottom:1px solid rgba(84,110,122,0.3); transition:background 0.15s; }
  .resumen-table tbody tr:hover { background:rgba(74,149,116,0.12); }
  .resumen-table tbody tr:nth-child(even) { background:rgba(0,0,0,0.12); }
  .resumen-table td { padding:9px 10px; color:var(--texto-claro); border-right:1px solid rgba(84,110,122,0.2); white-space:nowrap; }
  .resumen-table td.num { text-align:right; font-family:'Inter',monospace; font-weight:500; }
  .resumen-table td.positivo { color:#81c784; }
  .resumen-table td.negativo { color:#e57373; }
  /* totales fijos al fondo - igual que .table-footer del detalle */
  .resumen-footer {
    background:linear-gradient(90deg, #34495e, #2c3e50);
    padding:10px 14px; display:flex; justify-content:flex-end; gap:32px;
    border-top:2px solid var(--verde-claro); flex-shrink:0;
  }
  .resumen-footer-total {
    font-family:'Inter',sans-serif; font-size:0.86rem; font-weight:600; color:var(--dorado);
  }
  .resumen-footer-total span { color:var(--texto-claro); margin-left:9px; font-weight:400; }

  /* DETALLE */
  .detail-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; flex-shrink:0; }
  .detail-title { font-family:'Inter',sans-serif; font-size:1.1rem; font-weight:700; letter-spacing:1px; color:var(--dorado); text-transform:uppercase; }
  .table-wrapper {
    background:#2c3e50; border:1px solid #546e7a; border-radius:10px; overflow:hidden;
    box-shadow:0 4px 22px rgba(0,0,0,0.4);
    display:flex; flex-direction:column;
  }
  .table-scroll-area { flex:1; overflow-x:auto; overflow-y:auto; }
  .detail-table { width:100%; border-collapse:collapse; font-size:0.79rem; }
  .detail-table thead tr { background:linear-gradient(90deg, #3a7a65, #4a9574); }
  .detail-table thead th {
    padding:11px 10px; font-family:'Inter',sans-serif; font-size:0.76rem; font-weight:600;
    letter-spacing:1px; color:var(--texto-blanco); text-transform:uppercase; text-align:left;
    white-space:nowrap; border-right:1px solid rgba(255,255,255,0.15);
    position:sticky; top:0; z-index:2; background:linear-gradient(90deg, #3a7a65, #4a9574);
  }
  .detail-table tbody tr { border-bottom:1px solid rgba(84,110,122,0.3); transition:background 0.15s; }
  .detail-table tbody tr:hover { background:rgba(74,149,116,0.12); }
  .detail-table tbody tr:nth-child(even) { background:rgba(0,0,0,0.12); }
  .detail-table td { padding:8px 10px; color:var(--texto-claro); border-right:1px solid rgba(84,110,122,0.2); white-space:nowrap; max-width:260px; overflow:hidden; text-overflow:ellipsis; }
  .detail-table td.num { text-align:right; font-family:'Inter',monospace; font-weight:500; }
  .detail-table td.credito { color:#81c784; }
  .detail-table td.debito { color:#ffab91; }
  .detail-table td.monto-neg { color:#e57373; }
  .detail-table td.monto-pos { color:#81c784; }
  .table-footer { background:linear-gradient(90deg, #34495e, #2c3e50); padding:10px 14px; display:flex; justify-content:flex-end; gap:32px; border-top:2px solid var(--verde-claro); flex-shrink:0; }
  .footer-total { font-family:'Inter',sans-serif; font-size:0.86rem; font-weight:600; color:var(--dorado); }
  .footer-total span { color:var(--texto-claro); margin-left:9px; font-weight:400; }
  /* Detalle ocupa viewport completo */
  #page-detalle {
    display:none; padding:12px 24px;
    height: calc(100vh - 130px);
    flex-direction: column;
  }
  #page-detalle.active { display:flex; animation:fadeIn 0.3s ease; }
  #page-detalle .table-wrapper { flex:1; min-height:0; }
  #page-detalle .table-scroll-area { max-height:100%; }
  /* Resumen ocupa viewport completo */
  #page-resumen { display:none; padding:12px 24px; }
  #page-resumen.active { display:block; animation:fadeIn 0.3s ease; }

  ::-webkit-scrollbar { width:7px; height:7px; }
  ::-webkit-scrollbar-track { background:#1c2833; }
  ::-webkit-scrollbar-thumb { background:#4a9574; border-radius:4px; }

  @keyframes fadeIn {
    from{opacity:0; transform:translateY(8px)}
    to{opacity:1; transform:translateY(0)}
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">
    <h1>üè≠ DEPARTAMENTO DE PRESUPUESTOS IPG</h1>
    <span>Ingenio Palo Gordo, S.A. - Sistema de Presupuesto</span>
  </div>
  <div class="header-right">
    <span class="header-user">üë§ {{ nombre }}</span>
    <a href="/logout" class="btn-logout">Cerrar Sesi√≥n</a>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('dashboard',this)">üìä Dashboard</div>
  <div class="tab" onclick="switchTab('resumen',this)">üìà Resumen de Saldos</div>
  <div class="tab" onclick="switchTab('detalle',this)">üìã Detalle de Transacciones</div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TOOLTIP DE BARRAS ‚îÄ‚îÄ‚îÄ -->
<div id="global-tooltip" class="bar-tooltip">
  <div class="tooltip-title" id="tooltip-mes-label">DEBITOS POR CHEQUERA</div>
  <div class="bar-chart-container" id="tooltip-bar-container"></div>
</div>

<!-- ========== P√ÅGINA DASHBOARD ========== -->
<div id="page-dashboard" class="page active">
  <div class="dashboard-layout">

    <!-- PANEL IZQUIERDO: bot√≥n + filtros 2√ó4 -->
    <div class="filters-panel-left">
      <a href="/exportar-excel" class="btn-excel">‚ñ∂ Descargar Excel</a>

      <div class="filters-section">
        <div class="filter-group">
          <div class="filter-title">Administraci√≥n</div>
          <div class="filter-list" id="filter-administracion">
            {% for item in administraciones %}
            <div class="filter-item">
              <input type="checkbox" id="adm-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="adm-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Gerencia</div>
          <div class="filter-list" id="filter-gerencia">
            {% for item in gerencias %}
            <div class="filter-item">
              <input type="checkbox" id="ger-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="ger-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Centro de Costo</div>
          <div class="filter-list" id="filter-centro">
            {% for item in centros_costo %}
            <div class="filter-item">
              <input type="checkbox" id="cc-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="cc-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Nombre Centro Costo</div>
          <div class="filter-list" id="filter-responsable">
            {% for item in responsables %}
            <div class="filter-item">
              <input type="checkbox" id="res-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="res-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Chequera</div>
          <div class="filter-list" id="filter-chequera">
            {% for item in chequeras %}
            <div class="filter-item">
              <input type="checkbox" id="cheq-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="cheq-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Cod. Administraci√≥n</div>
          <div class="filter-list" id="filter-cod-admin">
            {% for item in cod_administraciones %}
            <div class="filter-item">
              <input type="checkbox" id="ca-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="ca-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Cod. Responsable</div>
          <div class="filter-list" id="filter-cod-responsable">
            {% for item in cod_responsables %}
            <div class="filter-item">
              <input type="checkbox" id="cr-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="cr-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-title">Cod. Centro de Costo</div>
          <div class="filter-list" id="filter-cod-centro">
            {% for item in cod_centros %}
            <div class="filter-item">
              <input type="checkbox" id="ccc-{{ loop.index }}" value="{{ item }}" onchange="aplicarFiltros()">
              <label for="ccc-{{ loop.index }}">{{ item }}</label>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <!-- /panel izquierdo -->

    <!-- PANEL DERECHO: KPIs + cilindros -->
    <div class="right-panel">
      <div class="kpis-row">
        <div class="kpi-card creditos">
          <div class="kpi-label">üí∞ Total Cr√©ditos</div>
          <div class="kpi-value" id="kpi-creditos">{{ kpis.total_creditos }}</div>
        </div>
        <div class="kpi-card debitos">
          <div class="kpi-label">üìâ Total D√©bitos</div>
          <div class="kpi-value" id="kpi-debitos">{{ kpis.total_debitos }}</div>
        </div>
        <div class="kpi-card neto">
          <div class="kpi-label">üíµ Saldo Actual</div>
          <div class="kpi-value" id="kpi-neto">{{ kpis.saldo_neto }}</div>
        </div>
      </div>

      <!-- Cilindros -->
      <div class="cylinders-section">
        <div class="cylinders-grid" id="cylinders-container"></div>
      </div>
    </div>

  </div>
</div>

<!-- ========== P√ÅGINA RESUMEN DE SALDOS ========== -->
<div id="page-resumen" class="page">
  <div class="resumen-container">
    <div class="resumen-header-bar">
      <div class="resumen-title">üìà Resumen de Saldos por Centro de Costo y Chequera</div>
    </div>
    <div class="resumen-scroll-area">
      <table class="resumen-table" id="tabla-resumen">
        <thead>
          <tr>
            <th>Centro de Costo</th>
            <th>Descripci√≥n</th>
            <th>Chequera</th>
            <th>Cr√©ditos</th>
            <th>D√©bitos</th>
            <th>Saldo</th>
          </tr>
        </thead>
        <tbody id="tbody-resumen"></tbody>
      </table>
    </div>
    <div class="resumen-footer">
      <div class="resumen-footer-total">Total Cr√©ditos <span id="total-creditos">Q0.00</span></div>
      <div class="resumen-footer-total">Total D√©bitos <span id="total-debitos">Q0.00</span></div>
      <div class="resumen-footer-total">Saldo Actual <span id="total-saldo">Q0.00</span></div>
    </div>
  </div>
</div>

<!-- ========== P√ÅGINA DETALLE ========== -->
<div id="page-detalle" class="page">
  <div class="detail-header">
    <div class="detail-title">üìã Detalle de Transacciones</div>
    <a href="/exportar-excel" class="btn-excel">‚ñ∂ Descargar Excel</a>
  </div>
  <div class="table-wrapper">
    <div class="table-scroll-area">
      {{ tabla_html | safe }}
    </div>
    <div class="table-footer">
      <div class="footer-total">Total Cr√©ditos <span id="footer-creditos">{{ kpis.total_creditos }}</span></div>
      <div class="footer-total">Total D√©bitos <span id="footer-debitos">{{ kpis.total_debitos }}</span></div>
      <div class="footer-total">Saldo Actual <span id="footer-neto">{{ kpis.saldo_neto }}</span></div>
    </div>
  </div>
</div>

<script>
const DATOS_MESES = {{ datos_meses | tojson }};
const DATOS_CHEQUERAS = {{ datos_chequeras_mes | tojson }};
const DATOS_RESUMEN = {{ datos_resumen | tojson }};
const MESES_ORDEN = ['NOVIEMBRE','DICIEMBRE','ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE'];

function formatK(v){
  if(!v||v===0)return'Q0';
  const a=Math.abs(v);
  let str;
  if(a>=1e9)str=(v/1e9).toFixed(1)+'B';
  else if(a>=1e6)str=(v/1e6).toFixed(1)+'M';
  else if(a>=1e3)str=(v/1e3).toFixed(1)+'K';
  else str=v.toFixed(0);
  return 'Q'+str;
}

function formatCurrency(v){
  return 'Q'+(v||0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g,'$&,');
}

// ‚îÄ‚îÄ‚îÄ CILINDRO SVG (igual al original, sin cambios) ‚îÄ‚îÄ‚îÄ
function buildCylinderSVG(creditos, debitos, w=100, h=160){
  const cx=50, rx=30, ry=8, top=22, bodyH=110, bot=top+bodyH;
  const overdraft=debitos>creditos&&debitos>0;
  const base=Math.max(creditos,1);
  const ratio=debitos>0?Math.min(debitos/base,1.0):0;
  const fillTopY=bot-ratio*bodyH;

  const c1=overdraft?'#c62828':'#d35400';
  const c2=overdraft?'#ef5350':'#e67e22';
  const c3=overdraft?'#ffcdd2':'#f39c12';

  const labelC=formatK(creditos);
  const labelD=formatK(debitos);
  const uid='c'+Math.random().toString(36).slice(2,8);

  return `<svg width="${w}" height="${h+28}" viewBox="0 0 ${w} ${h+28}" xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
<defs>
  <linearGradient id="gg-${uid}" x1="0" y1="0" x2="1" y2="0">
    <stop offset="0%" stop-color="#3a7a65" stop-opacity="0.25"/>
    <stop offset="50%" stop-color="#4a9574" stop-opacity="0.15"/>
    <stop offset="100%" stop-color="#2d5f4f" stop-opacity="0.28"/>
  </linearGradient>
  <linearGradient id="gf-${uid}" x1="0" y1="0" x2="1" y2="0">
    <stop offset="0%" stop-color="${c1}" stop-opacity="0.88"/>
    <stop offset="48%" stop-color="${c2}" stop-opacity="1.0"/>
    <stop offset="100%" stop-color="${c1}" stop-opacity="0.82"/>
  </linearGradient>
  <radialGradient id="silver-${uid}" cx="0.4" cy="0.3">
    <stop offset="0%" stop-color="#f0f0f0"/>
    <stop offset="50%" stop-color="#bdc3c7"/>
    <stop offset="100%" stop-color="#7f8c8d"/>
  </radialGradient>
</defs>
<ellipse cx="${cx}" cy="${bot+ry+6}" rx="${rx+6}" ry="6" fill="rgba(0,0,0,0.35)"/>
<ellipse cx="${cx}" cy="${bot+ry+4}" rx="${rx+4}" ry="5" fill="url(#silver-${uid})" stroke="#95a5a6" stroke-width="1"/>
<ellipse cx="${cx}" cy="${bot+ry+3}" rx="${rx+2}" ry="3.5" fill="rgba(236,240,241,0.6)"/>
<ellipse cx="${cx}" cy="${bot}" rx="${rx}" ry="${ry}" fill="#1a2f2a" stroke="#4a9574" stroke-width="1"/>
<rect x="${cx-rx}" y="${top}" width="${rx*2}" height="${bodyH}" fill="url(#gg-${uid})"/>
<line x1="${cx-rx}" y1="${top}" x2="${cx-rx}" y2="${bot}" stroke="rgba(180,235,180,0.4)" stroke-width="1.3"/>
${ratio>0?`
<rect x="${cx-rx+1}" y="${fillTopY}" width="${rx*2-2}" height="${bot-fillTopY}" fill="url(#gf-${uid})"/>
<line x1="${cx-rx+1}" y1="${fillTopY}" x2="${cx+rx-1}" y2="${fillTopY}" stroke="${c3}" stroke-width="1" opacity="0.7"/>
<ellipse cx="${cx}" cy="${fillTopY}" rx="${rx-1}" ry="${ry-1}" fill="${c2}" opacity="0.6"/>
`:''}
<ellipse cx="${cx}" cy="${top}" rx="${rx}" ry="${ry}" fill="#2d5f4f" stroke="rgba(180,235,180,0.6)" stroke-width="1.2"/>
<ellipse cx="${cx}" cy="${bot}" rx="${rx}" ry="${ry}" fill="#2a5a4a" stroke="rgba(180,235,180,0.5)" stroke-width="1.2"/>
<line x1="${cx-rx-12}" y1="${top}" x2="${cx+rx+5}" y2="${top}" stroke="#f1c40f" stroke-width="1.3" stroke-dasharray="4,3" opacity="0.9"/>
<line x1="${cx-rx-12}" y1="${top-5}" x2="${cx-rx-12}" y2="${top+5}" stroke="#f1c40f" stroke-width="1.8"/>
<text x="${cx-rx-14}" y="${top-7}" font-family="'Inter',sans-serif" font-size="8" font-weight="700" fill="#f1c40f" text-anchor="end">${labelC}</text>
<text x="${cx-rx-14}" y="${top+14}" font-family="'Inter',sans-serif" font-size="6" fill="rgba(241,196,15,0.8)" text-anchor="end">M√ÅX</text>
${ratio>0?`
<line x1="${cx+rx+2}" y1="${fillTopY}" x2="${cx+rx+10}" y2="${fillTopY}" stroke="${overdraft?'#ff8a80':'#f39c12'}" stroke-width="1" opacity="0.85"/>
<text x="${cx+rx+12}" y="${fillTopY+4}" font-family="'Inter',sans-serif" font-size="8" font-weight="700" fill="${overdraft?'#ff8a80':'#f39c12'}" text-anchor="start">${labelD}</text>
`:`<text x="${cx}" y="${bot-8}" font-family="'Inter',sans-serif" font-size="7" fill="#7f8c8d" text-anchor="middle">Sin d√©bitos</text>`}
${overdraft?`<text x="${cx}" y="${top-13}" font-family="'Inter',sans-serif" font-size="8" font-weight="700" fill="#ff5252" text-anchor="middle">‚ö† SOBRE</text>`:''}
</svg>`;
}

// ‚îÄ‚îÄ‚îÄ TOOLTIP GR√ÅFICO DE BARRAS ‚îÄ‚îÄ‚îÄ
const tooltipEl = document.getElementById('global-tooltip');
const tooltipMes = document.getElementById('tooltip-mes-label');
const tooltipCont = document.getElementById('tooltip-bar-container');
let hideTimeout;

function posTooltip(e){
  const tw = 340;
  const th = 220;
  const m = 14;
  let x = e.clientX + m;
  let y = e.clientY + m;
  if(x + tw > window.innerWidth)  x = e.clientX - tw - m;
  if(y + th > window.innerHeight) y = e.clientY - th - m;
  tooltipEl.style.left = x + 'px';
  tooltipEl.style.top  = y + 'px';
}

function mostrarTooltipBarras(mes, e){
  clearTimeout(hideTimeout);
  posTooltip(e);
  tooltipMes.textContent = mes + ' ¬∑ D√©bitos por chequera';
  tooltipEl.classList.add('visible');

  const chequData = DATOS_CHEQUERAS[mes] || {};
  const nombres = Object.keys(chequData);
  const debitos = Object.values(chequData);

  // Saldo = cr√©dito del mes - d√©bito por chequera
  // Como los datos originales solo tienen d√©bitos por chequera, mostramos saldo = -d√©bito
  // Si tienes cr√©dito por chequera en otro campo, ajusta aqu√≠.
  // Por ahora mostramos: D√©bito (negativo = gasto)
  if(nombres.length === 0){
    tooltipCont.innerHTML = '<div class="no-data-msg">Sin d√©bitos registrados</div>';
    return;
  }

  const maxVal = Math.max(...debitos.map(Math.abs), 1);

  let html = '';
  nombres.forEach((nom, i) => {
    const val = debitos[i];
    const saldo = -val; // el saldo es negativo (es un d√©bito/gasto)
    const pct = Math.min((Math.abs(val) / maxVal) * 100, 100);
    const clase = val === 0 ? 'neutro' : (saldo >= 0 ? 'positivo' : 'negativo');
    const label = formatK(val);

    html += `
      <div class="bar-row">
        <div class="bar-label" title="${nom}">${nom}</div>
        <div class="bar-track">
          <div class="bar-fill ${clase}" style="width:${pct}%">
            <span class="bar-value">${label}</span>
          </div>
        </div>
      </div>`;
  });

  tooltipCont.innerHTML = html;
}

function moverTooltip(e){ posTooltip(e); }
function ocultarTooltip(){ hideTimeout = setTimeout(() => tooltipEl.classList.remove('visible'), 130); }

// ‚îÄ‚îÄ‚îÄ RENDER CILINDROS ‚îÄ‚îÄ‚îÄ
function renderCilindros(dm){
  const c = document.getElementById('cylinders-container');
  c.innerHTML = '';
  MESES_ORDEN.forEach(mes => {
    const d = dm[mes] || {creditos:0, debitos:0};
    const card = document.createElement('div');
    card.className = 'cylinder-card';
    card.innerHTML = `
      <div class="cylinder-title">${mes}</div>
      <div class="cyl-svg-wrap">${buildCylinderSVG(d.creditos, d.debitos)}</div>
    `;
    c.appendChild(card);
    card.addEventListener('mouseenter', e => mostrarTooltipBarras(mes, e));
    card.addEventListener('mousemove',  e => moverTooltip(e));
    card.addEventListener('mouseleave', () => ocultarTooltip());
  });
}

// ‚îÄ‚îÄ‚îÄ RENDER RESUMEN ‚îÄ‚îÄ‚îÄ
function renderResumen(datos){
  const tbody = document.getElementById('tbody-resumen');
  tbody.innerHTML = '';
  let totalCred = 0, totalDeb = 0;

  if(!datos || datos.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#95a5a6;">Sin datos para mostrar</td></tr>';
    ['total-creditos','total-debitos'].forEach(id => document.getElementById(id).textContent = 'Q0.00');
    document.getElementById('total-saldo').textContent = 'Q0.00';
    return;
  }

  // Ordenar de menor a mayor por saldo (creditos - debitos)
  const sorted = [...datos].sort((a, b) => {
    const saldoA = (a.creditos || 0) - (a.debitos || 0);
    const saldoB = (b.creditos || 0) - (b.debitos || 0);
    return saldoA - saldoB;
  });

  sorted.forEach(row => {
    const saldo = row.creditos - row.debitos;
    totalCred += row.creditos;
    totalDeb  += row.debitos;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.centro_costo}</td>
      <td>${row.desc_centro||''}</td>
      <td>${row.chequera}</td>
      <td class="num positivo">${formatCurrency(row.creditos)}</td>
      <td class="num negativo">${formatCurrency(row.debitos)}</td>
      <td class="num ${saldo>=0?'positivo':'negativo'}">${formatCurrency(saldo)}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalSaldo = totalCred - totalDeb;
  document.getElementById('total-creditos').textContent = formatCurrency(totalCred);
  document.getElementById('total-debitos').textContent  = formatCurrency(totalDeb);
  const saldoEl = document.getElementById('total-saldo');
  saldoEl.textContent = formatCurrency(totalSaldo);
  saldoEl.style.color = totalSaldo >= 0 ? '#81c784' : '#e57373';
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ
function switchTab(p, el){
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  el.classList.add('active');
  if(p === 'dashboard') setTimeout(() => renderCilindros(DATOS_MESES), 100);
  if(p === 'resumen')   renderResumen(DATOS_RESUMEN);
}

// ‚îÄ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ‚îÄ
function getChecked(id){
  return Array.from(document.querySelectorAll(`#${id} input[type=checkbox]:checked`)).map(b => b.value);
}

function aplicarFiltros(){
  const filtros = {
    administracion:  getChecked('filter-administracion'),
    gerencia:        getChecked('filter-gerencia'),
    responsable:     getChecked('filter-responsable'),
    centro_costo:    getChecked('filter-centro'),
    chequera:        getChecked('filter-chequera'),
    cod_responsable: getChecked('filter-cod-responsable'),
    cod_admin:       getChecked('filter-cod-admin'),
    cod_centro:      getChecked('filter-cod-centro'),
  };
  fetch('/api/filtrar',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(filtros)
  })
  .then(r => r.json())
  .then(data => {
    document.getElementById('kpi-creditos').textContent = data.kpis.total_creditos;
    document.getElementById('kpi-debitos').textContent  = data.kpis.total_debitos;
    document.getElementById('kpi-neto').textContent     = data.kpis.saldo_neto;
    document.getElementById('footer-creditos').textContent = data.kpis.total_creditos;
    document.getElementById('footer-debitos').textContent  = data.kpis.total_debitos;
    document.getElementById('footer-neto').textContent     = data.kpis.saldo_neto;
    if(data.datos_chequeras_mes){
      Object.keys(DATOS_CHEQUERAS).forEach(k => delete DATOS_CHEQUERAS[k]);
      Object.assign(DATOS_CHEQUERAS, data.datos_chequeras_mes);
    }
    renderCilindros(data.datos_meses);
    if(data.datos_resumen) renderResumen(data.datos_resumen);
    document.querySelector('.table-wrapper .table-scroll-area').innerHTML = data.tabla_html;
    fixDetalleTable();
  })
  .catch(e => console.error('Error filtros:', e));
}

// ‚îÄ‚îÄ‚îÄ FIX TABLA DETALLE: reemplaza FECHA_DOCU por FECHA_OPER y ordena desc por fecha ‚îÄ‚îÄ‚îÄ
function fixDetalleTable(){
  const scrollArea = document.querySelector('.table-wrapper .table-scroll-area');
  if(!scrollArea) return;
  const table = scrollArea.querySelector('table');
  if(!table) return;

  const thead = table.querySelector('thead tr');
  const tbody = table.querySelector('tbody');
  if(!thead || !tbody) return;

  const ths = Array.from(thead.querySelectorAll('th'));

  // Encontrar √≠ndice de FECHA_DOCU y FECHA_OPER
  let idxDocuOld = -1, idxOper = -1;
  ths.forEach((th, i) => {
    const txt = th.textContent.trim().toUpperCase();
    if(txt === 'FECHA_DOCU') idxDocuOld = i;
    if(txt === 'FECHA_OPER') idxOper = i;
  });

  // Si FECHA_OPER existe como columna separada: reemplazar FECHA_DOCU con FECHA_OPER
  if(idxOper >= 0 && idxDocuOld >= 0){
    // Renombrar header de FECHA_DOCU ‚Üí FECHA_OPER y quitar columna FECHA_OPER original
    ths[idxDocuOld].textContent = 'FECHA_OPER';
    ths[idxOper].style.display = 'none';

    // En cada fila: copiar valor FECHA_OPER a posici√≥n FECHA_DOCU y ocultar celda FECHA_OPER
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if(tds[idxOper] && tds[idxDocuOld]){
        tds[idxDocuOld].textContent = tds[idxOper].textContent;
        tds[idxOper].style.display = 'none';
      }
    });
    idxDocuOld = idxDocuOld; // now this column holds FECHA_OPER values
  } else if(idxOper < 0 && idxDocuOld >= 0){
    // Solo renombrar cabecera
    ths[idxDocuOld].textContent = 'FECHA_OPER';
  }

  // Determinar √≠ndice de fecha para ordenar (FECHA_OPER/FECHA_DOCU)
  const sortIdx = idxOper >= 0 ? idxDocuOld : idxDocuOld;

  if(sortIdx < 0) return;

  // Ordenar filas de m√°s reciente a m√°s antigua
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.sort((a, b) => {
    const tdsA = a.querySelectorAll('td');
    const tdsB = b.querySelectorAll('td');
    const rawA = tdsA[sortIdx] ? tdsA[sortIdx].textContent.trim() : '';
    const rawB = tdsB[sortIdx] ? tdsB[sortIdx].textContent.trim() : '';
    // Parsear fecha: soporta DD/MM/YYYY, YYYY-MM-DD, MM/DD/YYYY
    const parseDate = s => {
      if(!s) return 0;
      // ISO format YYYY-MM-DD
      if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s).getTime();
      // DD/MM/YYYY
      const p = s.split(/[\/\-]/);
      if(p.length === 3){
        if(p[0].length === 4) return new Date(s).getTime();
        // Try DD/MM/YYYY
        return new Date(`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`).getTime();
      }
      return new Date(s).getTime();
    };
    return parseDate(rawB) - parseDate(rawA); // desc
  });

  rows.forEach(r => tbody.appendChild(r));
}

// ‚îÄ‚îÄ‚îÄ INICIO ‚îÄ‚îÄ‚îÄ
renderCilindros(DATOS_MESES);
renderResumen(DATOS_RESUMEN);
// Aplicar fix de tabla detalle al cargar
document.addEventListener('DOMContentLoaded', () => {
  fixDetalleTable();
});
// Por si el DOM ya est√° listo
fixDetalleTable();
</script>
</body>
</html>